variables:
  ALLOC_NAME: ${CI_PROJECT_NAME}_ci_${CI_PIPELINE_ID}
  CORONA_SHARED_ALLOC: "--exclusive --time-limit=60m --nodes=1"
  CORONA_JOB_ALLOC: "--nodes=1 --begin-time=+2s"

.on_corona:
  tags:
    - shell
    - corona
  rules:
    # Runs except if we explicitly deactivate corona by variable.
    - if: '$ON_CORONA == "OFF"'
      when: never
    # We should always release resources allocated in the pipeline.
    - if: '$CI_JOB_NAME =~ /release_resources/'
      when: always
    # A true statement is expected to allow jobs to run. Here is the default.
    - when: on_success

allocate_resources:
  variables:
    GIT_STRATEGY: none
  extends: .on_corona
  stage: .pre
  script:
    - |
      set -x
      flux --parent alloc ${CORONA_SHARED_ALLOC} --job-name=${ALLOC_NAME} --bg

release_resources:
  variables:
    GIT_STRATEGY: none
  extends: .on_corona
  stage: .post
  script:
    - |
      set -x
      export URI=$(flux jobs -o "{id} {name}" | grep ${ALLOC_NAME} | awk '{print $1}')
      ([[ -n "${URI}" ]] && flux job kill ${URI} || exit 0)
