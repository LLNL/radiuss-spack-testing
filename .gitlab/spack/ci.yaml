##############################################################################
# Copyright (c) 2021-2024, Lawrence Livermore National Security, LLC and
# RADIUSS Stack Testing project contributors.
# See the LICENSE file for details.
#
# SPDX-License-Identifier: MIT
##############################################################################

ci:
  target: gitlab
  pipeline-gen:

  - any-job:
      before_script:
        - echo "This section cannot be empty because of Spack CI implementation."

  - submapping:
    - match:
      - 'target=zen'
      build-job:
        tags: [corona, shell]
        script::
        - export ALLOC_ID=$(flux jobs --name="${ALLOC_NAME}" -n -o "{id}")
        - echo -e "[Information]: Shared allocation ID = ${ALLOC_ID}"
        - export PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"
        - ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs ${CORONA_JOB_ALLOC} .gitlab/spack/ci-script.sh)
    - match:
      - 'target=cascadelake'
      build-job:
        tags: [ruby, shell]
        script::
        - export JOBID=$(squeue -h --name=${ALLOC_NAME} --format=%A)
        - srun $( [[ -n "${JOBID}" ]] && echo "--jobid=${JOBID}" ) ${RUBY_JOB_ALLOC} .gitlab/spack/ci-script.sh
    - match:
      - 'target=power9le'
      build-job:
        tags: [lassen, shell]
        script::
        - lalloc ${LASSEN_JOB_ALLOC} .gitlab/spack/ci-script.sh
    - match:
      - 'target=zen3'
      build-job:
        tags: [tioga, shell]
        script::
        - export ALLOC_ID=$(flux jobs --name="${ALLOC_NAME}" -n -o "{id}")
        - echo -e "[Information]: Shared allocation ID = ${ALLOC_ID}"
        - export PROXY="$( [[ -n "${ALLOC_ID}" ]] && echo "flux proxy ${ALLOC_ID}" || echo "" )"
        - ${PROXY} flux watch $( ${PROXY} flux batch -o output.stdout.type=kvs ${TIOGA_JOB_ALLOC} .gitlab/spack/ci-script.sh)
    match_behavior: first

  - reindex-job:
      tags: [oslic, shell]
      before_script:
        - . ${MY_SPACK_PARENT_DIR}/spack/share/spack/setup-env.sh
        - export SPACK_DISABLE_LOCAL_CONFIG=""
        - export SPACK_USER_CACHE_PATH="${MY_SPACK_USER_CACHE}"
        - spack --version
        - spack ${MY_SPACK_DEBUG} config blame mirrors
        - spack ${MY_SPACK_DEBUG} mirror add --oci-username ${CI_REGISTRY_USER} --oci-password ${CI_REGISTRY_PASSWORD} buildcache-destination oci://${CI_REGISTRY_IMAGE}
        - spack ${MY_SPACK_DEBUG} config blame mirrors

  - noop-job:
      tags: [oslic, shell]

  - cleanup-job:
      tags: [oslic, shell]
