variables:
  ALLOC_NAME: ${CI_PROJECT_NAME}_ci_${CI_PIPELINE_ID}
  RUBY_SHARED_ALLOC: "--exclusive --reservation=ci --time=30 --nodes=2"
  RUBY_JOB_ALLOC: "--reservation=ci --overlap --nodes=1"

.on_ruby:
  tags:
    - shell
    - ruby
  rules:
    # Runs except if we explicitly deactivate ruby by variable.
    - if: '$ON_RUBY == "OFF"'
      when: never
      when: never
    # We should always release resources allocated in the pipeline.
    - if: '$CI_JOB_NAME =~ /release_resources/'
      when: always
    # A true statement is expected to allow jobs to run. Here is the default.
    - when: on_success

allocate_resources:
  variables:
    GIT_STRATEGY: none
  extends: .on_ruby
  stage: allocate-resources
  script:
    - salloc ${RUBY_SHARED_ALLOC} --no-shell --job-name=${ALLOC_NAME}

release_resources:
  variables:
    GIT_STRATEGY: none
  extends: .on_ruby
  stage: release-resources
  script:
    - export JOBID=$(squeue -h --name=${ALLOC_NAME} --format=%A)
    - ([[ -n "${JOBID}" ]] && scancel ${JOBID} || exit 0)
